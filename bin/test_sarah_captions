#!/usr/bin/env ruby
# frozen_string_literal: true

# Test caption generation for Sarah persona
# This script generates test captions without actually calling Ollama

require_relative '../config/environment'

puts "ğŸ§ª Testing Caption Generation for Sarah Persona"
puts "=" * 70
puts

persona = Persona.find_by(name: 'sarah')
unless persona
  puts "âŒ Sarah persona not found"
  exit 1
end

unless persona.caption_config
  puts "âŒ Sarah has no caption config"
  exit 1
end

puts "âœ“ Persona: #{persona.name}"
puts "âœ“ Tone: #{persona.caption_config.tone}"
puts "âœ“ Voice: #{persona.caption_config.voice_attributes.join(', ')}"
puts

# Test scenarios with different contexts
test_scenarios = [
  {
    name: "Coffee Shop Morning",
    cluster_name: "Coffee Culture",
    image_description: "A woman in a cozy sweater holding a latte in a sunlit cafe"
  },
  {
    name: "Urban Exploration",
    cluster_name: "City Streets",
    image_description: "A woman walking down a narrow street with vintage storefronts"
  },
  {
    name: "Fashion Detail",
    cluster_name: "Style & Fashion",
    image_description: "Close-up of a woman in a flowing dress against a brick wall"
  },
  {
    name: "Natural Light Portrait",
    cluster_name: "Portraits",
    image_description: "A woman by a window, natural light illuminating her face"
  },
  {
    name: "Everyday Moment",
    cluster_name: "Lifestyle",
    image_description: "A woman arranging flowers in a bright, minimal space"
  }
]

# Mock recent captions to test repetition avoidance
recent_captions = [
  "Just another perfect morning with coffee in hand",
  "Found this little gem of a cafe downtown",
  "Morning light makes everything better",
  "Coffee and contemplation before the day begins",
  "This cozy corner is becoming my favorite spot"
]

puts "ğŸ“ Generating test captions..."
puts "=" * 70
puts

test_scenarios.each_with_index do |scenario, index|
  puts "\n#{index + 1}. #{scenario[:name]}"
  puts "   Cluster: #{scenario[:cluster_name]}"
  puts "   Context: #{scenario[:image_description]}"
  puts "   " + "-" * 66
  
  # Build prompt (simulating what the AI would see)
  context = {
    cluster_name: scenario[:cluster_name],
    image_description: scenario[:image_description]
  }
  
  repetition_avoid = CaptionGenerations::RepetitionChecker.extract_phrases(recent_captions)
  
  prompt = CaptionGenerations::PromptBuilder.build(
    config: persona.caption_config,
    context: context,
    avoid_phrases: repetition_avoid
  )
  
  puts "\n   ğŸ“‹ System Prompt Preview (first 300 chars):"
  puts "   " + prompt[:system][0..300].gsub("\n", "\n   ")
  puts "   ..."
  
  puts "\n   ğŸ“‹ User Prompt:"
  puts "   " + prompt[:user].gsub("\n", "\n   ")
  
  puts "\n   ğŸ¤– Expected AI Response Pattern:"
  puts "   â€¢ Should reference moment/feeling, not appearance"
  puts "   â€¢ Should use understated language"
  puts "   â€¢ Should feel discovered, not performed"
  puts "   â€¢ Should include 0-1 emoji"
  puts "   â€¢ Should be 100-150 characters"
  
  puts
end

puts "\n" + "=" * 70
puts "ğŸ“Š Analysis"
puts "=" * 70

puts "\nâœ… Caption Config Strengths:"
puts "  â€¢ Tone 'casual' matches 'soft, unassuming charm'"
puts "  â€¢ Voice attributes support authenticity positioning"
puts "  â€¢ Low emoji density prevents over-performance"
puts "  â€¢ Example captions model the 'effortless' narrative"

puts "\nâš ï¸  Things to Monitor:"
puts "  â€¢ AI may still default to compliments ('beautiful', 'gorgeous')"
puts "  â€¢ Need to ensure moment-focus over appearance-focus"
puts "  â€¢ Repetition checker should catch overused phrases"
puts "  â€¢ Quality score should penalize overt self-awareness"

puts "\nğŸ¯ Recommendation:"
puts "  Generate 10-20 actual captions with Ollama and evaluate:"
puts "  1. Does it focus on moment vs. appearance?"
puts "  2. Does it feel 'discovered' vs. 'performed'?"
puts "  3. Is the beauty implied rather than stated?"
puts "  4. Would followers feel connection or intimidation?"

puts "\nğŸ’¡ To generate real captions:"
puts "  rake content_strategy:preview_next PERSONA=sarah"
puts
